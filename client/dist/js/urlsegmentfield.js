(function($){$.entwine("ss",function($){$(".field.urlsegment:not(.readonly)").entwine({MaxPreviewLength:55,Ellipsis:"...",onmatch:function(){if(this.find(":text").length)this.toggleEdit(false);this.redraw();this._super()},redraw:function(){var field=this.find(":text");if(typeof field.data("prefix")!="undefined"){url=decodeURI(field.data("prefix")+field.val())}else{url=decodeURI(field.val())}previewUrl=url;if(url.length>this.getMaxPreviewLength()){previewUrl=this.getEllipsis()+url.substr(url.length-this.getMaxPreviewLength(),url.length)}this.find(".URL-link").attr("href",encodeURI(url+field.data("suffix"))).text(previewUrl)},toggleEdit:function(toggle){var field=this.find(":text");this.find(".preview-holder")[toggle?"hide":"show"]();this.find(".edit-holder")[toggle?"show":"hide"]();if(toggle){field.data("origval",field.val());field.focus()}},update:function(){var self=this,field=this.find(":text"),currentVal=field.data("origval"),title=arguments[0],updateVal=title&&title!==""?title:field.val();if(currentVal!=updateVal){this.addClass("loading");this.suggest(updateVal,function(data){field.val(decodeURIComponent(data.value));self.toggleEdit(false);self.removeClass("loading");self.redraw()})}else{this.toggleEdit(false);this.redraw()}},cancel:function(){var field=this.find(":text");field.val(field.data("origval"));this.toggleEdit(false)},suggest:function(val,callback){var self=this,field=self.find(":text"),urlParts=$.path.parseUrl(self.closest("form").attr("action")),url=urlParts.hrefNoSearch+"/field/"+field.attr("name")+"/suggest/?value="+encodeURIComponent(val);if(urlParts.search)url+="&"+urlParts.search.replace(/^\?/,"");$.ajax({url:url,success:function(data){callback.apply(this,arguments)},error:function(xhr,status){xhr.statusText=xhr.responseText},complete:function(){self.removeClass("loading")}})}});$(".field.urlsegment .edit").entwine({onclick:function(e){e.preventDefault();this.closest(".field").toggleEdit(true)}});$(".field.urlsegment .update").entwine({onclick:function(e){e.preventDefault();this.closest(".field").update()}});$(".field.urlsegment .cancel").entwine({onclick:function(e){e.preventDefault();this.closest(".field").cancel()}})})})(jQuery);